name: PR Format Check

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/pr-format-check.yml'

jobs:
  tofu-format-check:
    name: OpenTofu Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Run tofu fmt check
        id: fmt
        run: |
          echo "Running tofu fmt -recursive -check..."
          if tofu fmt -recursive -check; then
            echo "✅ All OpenTofu files are properly formatted"
            exit 0
          else
            echo "❌ Format check failed. Please run 'tofu fmt -recursive' to fix formatting issues."
            echo ""
            echo "The following files need formatting:"
            tofu fmt -recursive -check -diff
            exit 1
          fi

      - name: Comment PR on failure
        if: failure() && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ OpenTofu Format Check Failed
              
              The OpenTofu format check has failed. Please run the following command to fix formatting issues:
              
              \`\`\`bash
              tofu fmt -recursive
              \`\`\`
              
              Then commit and push the changes.`
            })
