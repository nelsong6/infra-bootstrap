name: Consolidated Deployment

on:
  push:
    branches: ['**']
    # Removing paths entirely means this will trigger on ANY file change in the repo
  workflow_dispatch:
    inputs:
      run_infra:
        description: 'Deploy Infrastructure (OpenTofu)'
        required: true
        type: boolean
        default: true
      action:
        description: 'OpenTofu action (if running infra)'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

concurrency:
  group: "master-deployment-lock"
  cancel-in-progress: false

permissions:
  id-token: write
  contents: write
  pull-requests: write
  actions: write
  packages: write

jobs:
  # ==========================================
  # 1. INFRASTRUCTURE
  # ==========================================
  deploy-infra:
    # Run on pushes, or if manually triggered and the checkbox is checked
    if: ${{ github.event_name == 'push' || inputs.run_infra }}
    uses: nelsong6/pipeline-templates/.github/workflows/tofu-deploy-template.yml@main
    with:
      action: ${{ inputs.action || 'apply' }}
    secrets: inherit
